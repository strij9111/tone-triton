name: "streaming_acoustic"
platform: "onnxruntime_onnx"

#######################################################################
# 1. Batching
#######################################################################
max_batch_size: 16                 # implicit batch; Triton добавит ось N

#######################################################################
# 2. Inputs
#######################################################################
input [
  # Аудио‑фрагмент 2400 сэмплов (примерно 150 мс при 16 кГц)
  {
    name: "signal"
    data_type: TYPE_INT32
    dims: [ 2400, 1 ]             # Triton ⇒ [-1,2400,1]
  },

  # Скрытое состояние RNN/Transducer
  {
    name: "state"
    data_type: TYPE_FP16
    dims: [ 219729 ]              # Triton ⇒ [-1,219729]
  }
]

#######################################################################
# 3. Outputs
#######################################################################
output [
  # Log‑softmax (CTC/Transducer) для каждого тайм‑шага
  {
    name: "logprobs"
    data_type: TYPE_FP32
    dims: [ -1, 35 ]              # Triton ⇒ [-1,-1,35]
  },

  # Обновлённое состояние
  {
    name: "state_next"
    data_type: TYPE_FP16
    dims: [ -1 ]                  # Triton ⇒ [-1,-1]  (совпадает с ONNX)
  }
]

#######################################################################
# 4. Dynamic batching – склейка запросов разных сессий
#######################################################################
dynamic_batching {
  max_queue_delay_microseconds: 100   # ≤ 10 мс ожидания
}

#######################################################################
# 5. Размещение экземпляра
#######################################################################
instance_group [
  { name: "gpu0" count: 10 kind: KIND_GPU gpus: [0] }
]

#######################################################################
# 6. Warm‑up – две схемы: одиночная и полная батч‑нагрузка
#######################################################################
model_warmup [
  {
    name: "warmup_sample_1"
    batch_size: 1
    count: 10
    inputs: {
      key: "signal",
      value: { data_type: TYPE_INT32 dims: [ 2400, 1 ] zero_data: true }
    }
    inputs: {
      key: "state",
      value: { data_type: TYPE_FP16 dims: [ 219729 ] zero_data: true }
    }
  },
  {
    name: "warmup_sample_2"
    batch_size: 16
    count: 10
    inputs: {
      key: "signal",
      value: { data_type: TYPE_INT32 dims: [ 2400, 1 ] zero_data: true }
    }
    inputs: {
      key: "state",
      value: { data_type: TYPE_FP16 dims: [ 219729 ] zero_data: true }
    }
  }
]

#######################################################################
# 7. (Необязательно) Политика транзакций для gRPC‑стрима Triton ≥ 24.04
# model_transaction_policy { decoupled: true }
#######################################################################
